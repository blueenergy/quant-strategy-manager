# WebSocket æ—¥å¿—æµåŠŸèƒ½å®æ–½æ€»ç»“

## å®æ–½å®Œæˆ âœ…

ç±»ä¼¼ Jenkins Console Output çš„å®æ—¶æ—¥å¿—æµåŠŸèƒ½å·²æˆåŠŸé›†æˆåˆ° `quant-strategy-manager` æ¡†æ¶ä¸­ã€‚

## ä¿®æ”¹çš„æ–‡ä»¶

### æ ¸å¿ƒä»£ç 

1. **`src/strategy_manager/core/strategy_worker.py`**
   - âœ… æ·»åŠ  `_log_server` å±æ€§
   - âœ… æ·»åŠ  `get_log_stream_url()` æ–¹æ³•
   - âœ… åœ¨ `get_worker_info()` ä¸­åŒ…å« WebSocket URL

2. **`src/strategy_manager/adapters/vnpy_adapter.py`**
   - âœ… å¯¼å…¥ `LogStreamServer` å’Œ `WebSocketLogHandler`
   - âœ… åœ¨ `__init__` ä¸­åˆ›å»º LogStreamServerï¼ˆåŠ¨æ€ç«¯å£ï¼‰
   - âœ… æ·»åŠ  WebSocketLogHandler åˆ° logger
   - âœ… åœ¨ `stop()` æ–¹æ³•ä¸­æ¸…ç† LogStreamServer

3. **`src/strategy_manager/core/multi_strategy_orchestrator.py`**
   - âœ… åœ¨ `get_status()` ä¸­è¿”å›æ¯ä¸ª worker çš„ `log_stream_url`

### ç¤ºä¾‹å’Œæ–‡æ¡£

4. **`examples/log_viewer.html`** (æ–°å»º)
   - å•ä¸ª Worker çš„æ§åˆ¶å°æ—¥å¿—æŸ¥çœ‹å™¨
   - ç±»ä¼¼ Jenkins Console Output çš„ç•Œé¢
   - æ”¯æŒå®æ—¶è¿æ¥ã€æ–­å¼€ã€æ¸…ç©º

5. **`examples/dashboard.html`** (æ–°å»º)
   - å¤š Worker çš„ Dashboard
   - ç½‘æ ¼å¸ƒå±€ï¼ŒåŒæ—¶æŸ¥çœ‹å¤šä¸ª Worker
   - ä» REST API è‡ªåŠ¨åŠ è½½ Workers

6. **`examples/test_log_streaming.py`** (æ–°å»º)
   - æµ‹è¯•å•ä¸ª Worker çš„æ—¥å¿—æµ
   - æµ‹è¯•å¤šä¸ª Workers æ¨¡æ‹Ÿ
   - å¯æ‰§è¡Œçš„ç¤ºä¾‹ä»£ç 

7. **`examples/api_with_log_streaming.py`** (æ–°å»º)
   - Flask REST API ç¤ºä¾‹
   - å±•ç¤ºå¦‚ä½•æš´éœ² WebSocket URLs
   - åŒ…å«å®Œæ•´çš„ API æ–‡æ¡£

8. **`docs/LOG_STREAMING_GUIDE.md`** (æ–°å»º)
   - å®Œæ•´çš„ä½¿ç”¨æŒ‡å—
   - æ¶æ„è¯´æ˜
   - é›†æˆç¤ºä¾‹
   - æ•…éšœæ’æŸ¥
   - é«˜çº§ç”¨æ³•

9. **`README.md`** (æ›´æ–°)
   - æ·»åŠ äº† "Real-Time Log Streaming" ç« èŠ‚
   - åŒ…å«åŠŸèƒ½è¯´æ˜å’Œä½¿ç”¨ç¤ºä¾‹

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StrategyWorker (æ¯ä¸ªç­–ç•¥ä¸€ä¸ª)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  LogStreamServer (åŠ¨æ€ç«¯å£)              â”‚   â”‚
â”‚  â”‚  ws://0.0.0.0:54321                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â†‘                                        â”‚
â”‚         â”‚ WebSocketLogHandler                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Logger                                  â”‚    â”‚
â”‚  â”‚  â€¢ StreamHandler â†’ Console               â”‚    â”‚
â”‚  â”‚  â€¢ WebSocketLogHandler â†’ WebSocket       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ WebSocket
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµè§ˆå™¨ (log_viewer.html / dashboard.html)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°

1. **ç‹¬ç«‹ WebSocket æœåŠ¡**
   - æ¯ä¸ª Worker æœ‰ç‹¬ç«‹çš„ LogStreamServer
   - åŠ¨æ€ç«¯å£åˆ†é…ï¼Œé¿å…å†²çª
   - è‡ªåŠ¨å¯åŠ¨å’Œæ¸…ç†

2. **åŒé‡æ—¥å¿—è¾“å‡º**
   - Console: ä¼ ç»Ÿçš„æ§åˆ¶å°è¾“å‡º
   - WebSocket: å®æ—¶æµå¼ä¼ è¾“åˆ°æµè§ˆå™¨

3. **å®Œæ•´çš„å‰ç«¯æ”¯æŒ**
   - å• Worker æŸ¥çœ‹å™¨
   - å¤š Worker Dashboard
   - é¢œè‰²ç¼–ç çš„æ—¥å¿—çº§åˆ«
   - è‡ªåŠ¨æ»šåŠ¨

4. **REST API é›†æˆ**
   - `get_status()` è¿”å› WebSocket URLs
   - å‰ç«¯å¯è‡ªåŠ¨å‘ç°å’Œè¿æ¥

5. **å®Œæ•´æ–‡æ¡£**
   - ä½¿ç”¨æŒ‡å—
   - é›†æˆç¤ºä¾‹
   - API å‚è€ƒ

## ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿæµ‹è¯•

```bash
# 1. æµ‹è¯•å•ä¸ª Worker
python examples/test_log_streaming.py

# 2. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€
open examples/log_viewer.html

# 3. è¾“å…¥æ˜¾ç¤ºçš„ WebSocket URL å¹¶è¿æ¥
```

### å®é™…ä½¿ç”¨

```bash
# 1. å¯åŠ¨ç­–ç•¥ç®¡ç†å™¨
python -m strategy_manager.cli start

# 2. æŸ¥çœ‹ Worker çŠ¶æ€ï¼ˆè·å– WebSocket URLsï¼‰
# é€šè¿‡ REST API æˆ–ç›´æ¥è°ƒç”¨ orchestrator.get_status()

# 3. åœ¨æµè§ˆå™¨ä¸­è¿æ¥åˆ°å¯¹åº”çš„ WebSocket URL
```

### Dashboard æ¨¡å¼ï¼ˆæ¨èï¼‰

```bash
# 1. å¯åŠ¨ API æœåŠ¡å™¨
python examples/api_with_log_streaming.py

# 2. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€
open examples/dashboard.html

# Dashboard ä¼šè‡ªåŠ¨åŠ è½½æ‰€æœ‰ Workers å¹¶æ˜¾ç¤ºè¿æ¥æŒ‰é’®
```

## æ¶ˆæ¯æ ¼å¼

### WebSocket æ—¥å¿—æ¶ˆæ¯

```json
{
  "timestamp": "2026-02-01T14:30:25.123456",
  "level": "INFO",
  "message": "Bar processed: #1234",
  "logger_name": "VnpyWorker[002050.SZ]",
  "module": "vnpy_adapter",
  "func_name": "run",
  "line_no": 95
}
```

## å¯¹æ¯”ä¼ ç»Ÿæ–¹æ¡ˆ

### ä¼ ç»Ÿæ–¹æ¡ˆï¼šå†™å…¥æ•°æ®åº“
```
Logger â†’ MongoDB â†’ å‰ç«¯æŸ¥è¯¢ â†’ æ˜¾ç¤º
```
**é—®é¢˜ï¼š**
- âŒ æ•°æ®åº“å‹åŠ›å¤§
- âŒ æŸ¥è¯¢æœ‰å»¶è¿Ÿ
- âŒ å­˜å‚¨æˆæœ¬é«˜
- âŒ éœ€è¦å®šæœŸæ¸…ç†

### æ–°æ–¹æ¡ˆï¼šWebSocket æµå¼ä¼ è¾“
```
Logger â†’ WebSocket â†’ æµè§ˆå™¨å®æ—¶æ˜¾ç¤º
```
**ä¼˜åŠ¿ï¼š**
- âœ… æ— æ•°æ®åº“ä¾èµ–
- âœ… å®æ—¶æ— å»¶è¿Ÿ
- âœ… é›¶å­˜å‚¨æˆæœ¬
- âœ… ç±»ä¼¼ Jenkins ä½“éªŒ

## ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. å®‰å…¨æ€§
```python
# åªç›‘å¬æœ¬åœ°
LogStreamServer(host="127.0.0.1", port=0)

# æˆ–ä½¿ç”¨ Nginx åå‘ä»£ç† + è®¤è¯
```

### 2. èµ„æºæ§åˆ¶
```python
# é™åˆ¶è¿æ¥æ•°
class LogStreamServer:
    def __init__(self, max_clients=5):
        ...
```

### 3. æ—¥å¿—ç¼“å†²
```python
# ä¿ç•™æœ€è¿‘ 1000 æ¡æ—¥å¿—
from collections import deque
self.log_buffer = deque(maxlen=1000)
```

## ä¸‹ä¸€æ­¥

### å¯é€‰ä¼˜åŒ–

1. **æ—¥å¿—ç¼“å†²åŒº** - æ–°è¿æ¥æ—¶æ˜¾ç¤ºå†å²æ—¥å¿—
2. **è¿æ¥æ•°é™åˆ¶** - é¿å…èµ„æºè€—å°½
3. **æ—¥å¿—å‹ç¼©** - ä½¿ç”¨ permessage-deflate
4. **è®¤è¯æœºåˆ¶** - ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ§åˆ¶
5. **æ‰¹é‡å‘é€** - å‡å°‘ WebSocket æ¶ˆæ¯æ•°é‡

### æ‰©å±•åŠŸèƒ½

1. **æ—¥å¿—æœç´¢** - å‰ç«¯è¿‡æ»¤å’Œæœç´¢
2. **å¯¼å‡ºåŠŸèƒ½** - ä¸‹è½½æ—¥å¿—åˆ°æœ¬åœ°
3. **æ€§èƒ½æŒ‡æ ‡** - åœ¨æ—¥å¿—ä¸­åµŒå…¥æ€§èƒ½æ•°æ®
4. **å‘Šè­¦é›†æˆ** - ERROR æ—¥å¿—è§¦å‘å‰ç«¯é€šçŸ¥

## å…¼å®¹æ€§

- âœ… å®Œå…¨å…¼å®¹ç°æœ‰ä»£ç 
- âœ… ä¸å½±å“æ§åˆ¶å°æ—¥å¿—è¾“å‡º
- âœ… å¯é€‰åŠŸèƒ½ï¼ˆå¤±è´¥æ—¶é™çº§åˆ°çº¯æ§åˆ¶å°ï¼‰
- âœ… æ”¯æŒä»»æ„ StrategyWorker å­ç±»

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
```
examples/
  â”œâ”€â”€ log_viewer.html              # å• Worker æ—¥å¿—æŸ¥çœ‹å™¨
  â”œâ”€â”€ dashboard.html               # å¤š Worker Dashboard
  â”œâ”€â”€ test_log_streaming.py        # æµ‹è¯•è„šæœ¬
  â””â”€â”€ api_with_log_streaming.py    # REST API ç¤ºä¾‹

docs/
  â””â”€â”€ LOG_STREAMING_GUIDE.md       # å®Œæ•´ä½¿ç”¨æŒ‡å—
```

### ä¿®æ”¹æ–‡ä»¶
```
src/strategy_manager/
  â”œâ”€â”€ core/
  â”‚   â”œâ”€â”€ strategy_worker.py       # æ·»åŠ æ—¥å¿—æµæ”¯æŒ
  â”‚   â””â”€â”€ multi_strategy_orchestrator.py  # è¿”å› WebSocket URLs
  â””â”€â”€ adapters/
      â””â”€â”€ vnpy_adapter.py          # é›†æˆ LogStreamServer

README.md                          # æ·»åŠ åŠŸèƒ½è¯´æ˜
```

### å·²æœ‰æ–‡ä»¶ï¼ˆæœªä¿®æ”¹ï¼‰
```
src/strategy_manager/
  â”œâ”€â”€ log_stream_server.py         # WebSocket æœåŠ¡å™¨
  â””â”€â”€ log_handlers.py              # WebSocketLogHandler
```

## æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] Worker å¯åŠ¨æ—¶åˆ›å»º LogStreamServer
- [ ] å¯ä»¥é€šè¿‡ `get_log_stream_url()` è·å– URL
- [ ] æ—¥å¿—åŒæ—¶è¾“å‡ºåˆ° console å’Œ WebSocket
- [ ] æµè§ˆå™¨å¯ä»¥è¿æ¥å¹¶æ¥æ”¶æ—¥å¿—
- [ ] Worker åœæ­¢æ—¶è‡ªåŠ¨å…³é—­ LogStreamServer
- [ ] å¤šä¸ª Workers ä½¿ç”¨ä¸åŒç«¯å£
- [ ] `get_status()` è¿”å› WebSocket URLs

## æ€»ç»“

âœ… **å®æ–½å®Œæˆï¼** 

å·²æˆåŠŸä¸º `quant-strategy-manager` æ·»åŠ äº†ç±»ä¼¼ Jenkins Console Output çš„å®æ—¶æ—¥å¿—æµåŠŸèƒ½ï¼Œå®Œå…¨ä¸éœ€è¦å°†æ—¥å¿—å†™å…¥æ•°æ®åº“ã€‚æ¯ä¸ª Worker éƒ½æœ‰ç‹¬ç«‹çš„ WebSocket æœåŠ¡ï¼Œå‰ç«¯å¯ä»¥å®æ—¶æŸ¥çœ‹æ—¥å¿—è¾“å‡ºã€‚

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**
- ğŸš€ å®æ—¶æ— å»¶è¿Ÿ
- ğŸ’¾ é›¶æ•°æ®åº“å‹åŠ›
- ğŸ¨ å‹å¥½çš„ç•Œé¢
- ğŸ”§ æ˜“äºé›†æˆ

ç°åœ¨ä½ å¯ä»¥åƒæŸ¥çœ‹ Jenkins æ„å»ºæ—¥å¿—ä¸€æ ·ï¼Œå®æ—¶æŸ¥çœ‹æ¯ä¸ªç­–ç•¥çš„è¿è¡Œæ—¥å¿—ï¼
